<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Article Title Here</title>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: rgb(249, 251, 231);
      color: #333;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      text-align: center;
    }
    h1, h2, h3 {
      color: #222;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px; /* Added rounded corners for images */
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    blockquote {
      border-left: 4px solid #888;
      margin-left: 0;
      padding-left: 1rem;
      font-style: italic;
      color: #555;
      background-color: #f5f5f5; /* Light background for blockquotes */
      padding: 10px 15px;
      border-radius: 4px;
    }
    .footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #777;
      text-align: center;
    }
    button.action-btn { /* Renamed from like-btn for generality */
      background-color: #eee;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 8px 15px; /* Slightly larger padding */
      margin-top: 10px;
      font-family: 'Montserrat', sans-serif;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button.action-btn:hover {
        background-color: #e0e0e0;
    }
    #authStatus {
      margin-bottom: 1rem;
      font-weight: bold;
    }
    #loginBtn, #logoutBtn {
      background-color: #2ECC71;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 0 5px;
      font-family: 'Montserrat', sans-serif;
      transition: background-color 0.3s ease;
    }
    #loginBtn:hover, #logoutBtn:hover {
        background-color: #27ae60;
    }
    textarea {
      width: 100%;
      height: 100px; /* Slightly taller textarea */
      padding: 10px;
      margin: 10px 0;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      resize: vertical;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    input[type="text"], input[type="email"] {
      width: 100%;
      padding: 10px;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #commentsList > div {
      text-align: left;
      border-bottom: 1px solid #eee; /* Lighter border for comments */
      padding: 15px 0;
      margin-bottom: 10px;
    }
    #commentsList > div:last-child {
        border-bottom: none;
    }
    .article-content {
        text-align: left; /* Align article content to the left */
        line-height: 1.6; /* Improve readability */
        margin-top: 2rem;
    }
    .article-content p {
        margin-bottom: 1em;
    }
    .article-meta {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 1.5rem;
    }
    .section-divider {
        border: 0;
        height: 1px;
        background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
        margin: 40px 0;
    }
  </style>
</head>

<body>
  <h1>[Article Title]</h1>
  <p class="article-meta">By: <a href="[author-profile-link]">Author Name</a> | Published: [Date]</p>

  <!-- Authentication and Interaction Section -->
  <div id="authStatus">Loading authentication status...</div>
  <button id="loginBtn" style="display: inline-block;">Login / Signup</button>
  <button id="logoutBtn" style="display: none;">Logout</button>

  <button class="action-btn" id="likeArticleBtn">❤️ Like Article (<span id="articleLikes">0</span>)</button>
  <!-- You can add other action buttons here, e.g., share, save -->

  <hr class="section-divider" />

  <!-- Main Article Content -->
  <div class="article-content">
    <h2>Introduction</h2>
    <p>This is where your introductory paragraph goes. Set the stage for your readers and introduce the main topic of your article. Keep it engaging to hook your audience.</p>

    <p>You can add more paragraphs here to expand on your ideas. Break down complex information into smaller, digestible chunks. Use clear and concise language.</p>

    <h3>Sub-heading One</h3>
    <p>This section can delve deeper into a specific aspect of your topic. Provide details, examples, or supporting evidence for your claims.</p>

    <blockquote>
      “This is an example of a blockquote. Use it for impactful quotes or to highlight important statements from other sources.”
      <br />
      – [Source of Quote]
    </blockquote>

    <p>
      You can also include images to break up text and provide visual context. Remember to use descriptive `alt` text for accessibility.
    </p>
    <img src="https://placehold.co/800x450/cccccc/333333?text=Placeholder+Image" alt="Descriptive image alt text" />
    <p style="font-size: 0.85em; color: #777;"><em>Caption for the image.</em></p>

    <h3>Sub-heading Two</h3>
    <p>Continue developing your arguments or narrative here. Ensure a logical flow between sections. Think about what your readers need to know next.</p>

    <ul>
      <li>Point one: Use lists to present information clearly.</li>
      <li>Point two: They are great for summarizing key takeaways.</li>
      <li>Point three: Or for outlining steps or features.</li>
    </ul>

    <p>Conclude your main content by summarizing your key points and offering a final thought or call to action, if applicable.</p>
  </div>

  <hr class="section-divider" />

  <!-- Comments Section -->
  <div id="comments-section">
    <h2>Comments</h2>
    <form id="commentForm">
      <input type="text" id="name" placeholder="Your name (anonymous allowed)" required /><br />
      <textarea id="comment" placeholder="Your comment" required></textarea><br />
      <button type="submit" class="action-btn">Post Comment</button>
    </form>
    <div id="commentsList">
      <!-- Comments will be loaded here dynamically -->
      <p>No comments yet. Be the first!</p>
    </div>
  </div>

  <!-- Article Rating Section -->
  <div
    id="rate-me"
    style="
      font-family: Arial, sans-serif;
      margin: 50px auto;
      text-align: center;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f9f9f9;
      max-width: 400px;
    "
  >
    <label style="font-weight: bold;">Rate The Article:</label>
    <br />
    <div
      id="stars-container"
      class="stars"
      style="display: flex; justify-content: center; cursor: pointer; font-size: 3rem; color: lightgray; text-align: center;"
    >
      <span class="star" data-value="1" style="margin-right: 10px;">★</span>
      <span class="star" data-value="2" style="margin-right: 10px;">★</span>
      <span class="star" data-value="3" style="margin-right: 10px;">★</span>
      <span class="star" data-value="4" style="margin-right: 10px;">★</span>
      <span class="star" data-value="5">★</span>
    </div>
    <p id="rating-result" style="font-size: 1.2rem; font-weight: bold;"></p>
  </div>

  <div class="footer">
    <p>© [Current Year] Your Blog Name. All rights reserved.</p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // IMPORTANT: Firebase project configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC-p_D5KgLbpMm_5REwdDaaq-YBrE3pwkk",
      authDomain: "sportssquare-b96ed.firebaseapp.com",
      projectId: "sportssquare-b96ed",
      storageBucket: "sportssquare-b96ed.firebasestorage.app",
      messagingSenderId: "844736978057",
      appId: "1:844736978057:web:76c8db520d3c27bdeb7a58"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Get references to DOM elements
    const authStatus = document.getElementById("authStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const articleLikesSpan = document.getElementById("articleLikes");
    const likeArticleBtn = document.getElementById("likeArticleBtn");
    const commentsList = document.getElementById("commentsList");
    const commentForm = document.getElementById("commentForm");
    const starsContainer = document.getElementById("stars-container");
    const ratingResult = document.getElementById("rating-result");

    let currentUser = null; // Variable to store the current authenticated user

    // Helper function to escape HTML for display
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Authentication state change listener
    auth.onAuthStateChanged(async (user) => {
      currentUser = user; // Update current user
      if (user) {
        authStatus.textContent = `Welcome, ${user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        authStatus.textContent = "You are not logged in.";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
      // Load dynamic data after authentication status is determined
      await loadArticleLikes();
      await loadComments();
      await loadUserRating();
    });

    // Login button click handler
    loginBtn.onclick = () => {
      // Redirect to signup.html, passing the current page URL as a redirect parameter
      window.location.href = `../signup.html?redirect=${encodeURIComponent(window.location.href)}`;
    };

    // Logout button click handler
    logoutBtn.onclick = () => {
      auth.signOut(); // Sign out the user
    };

    // Function to load and display article likes
    async function loadArticleLikes() {
      try {
        // Get the 'article' document from the 'likes' collection
        const doc = await db.collection("likes").doc("article").get();
        // Get the likes count, defaulting to 0 if not found
        const likesCount = doc.exists && doc.data().count ? doc.data().count : 0;
        articleLikesSpan.textContent = likesCount; // Update the display
      } catch (error) {
        console.error("Failed to load article likes:", error);
      }
    }

    // Function to handle article liking
    likeArticleBtn.onclick = async () => {
      if (!currentUser) {
        showMessageBox("You need to be logged in to like the article.");
        return;
      }
      try {
        // Check if the current user has already liked this article
        const userLikeDoc = await db
          .collection("likes")
          .doc("articleLikesUsers")
          .collection("users")
          .doc(currentUser.uid)
          .get();

        if (userLikeDoc.exists) {
          showMessageBox("You already liked this article!");
          return;
        }

        // Record that the user liked the article
        await db
          .collection("likes")
          .doc("articleLikesUsers")
          .collection("users")
          .doc(currentUser.uid)
          .set({ liked: true });

        // Update the total article likes count using a transaction for atomicity
        const articleLikesRef = db.collection("likes").doc("article");
        await db.runTransaction(async (transaction) => {
          const doc = await transaction.get(articleLikesRef);
          if (!doc.exists) {
            transaction.set(articleLikesRef, { count: 1 }); // If no likes yet, set to 1
          } else {
            const newCount = (doc.data().count || 0) + 1; // Increment count
            transaction.update(articleLikesRef, { count: newCount });
          }
        });

        await loadArticleLikes(); // Reload likes to update display
      } catch (error) {
        console.error("Error liking article:", error);
        showMessageBox("Failed to like the article. Please try again.");
      }
    };

    // Function to load and display comments
    async function loadComments() {
      try {
        // Get comments ordered by timestamp (newest first)
        const snapshot = await db.collection("comments").orderBy("timestamp", "desc").get();
        commentsList.innerHTML = ""; // Clear existing comments
        if (snapshot.empty) {
          commentsList.textContent = "No comments yet. Be the first!";
          return;
        }
        snapshot.forEach((doc) => {
          const data = doc.data();
          const commentDiv = document.createElement("div");
          commentDiv.style.borderBottom = "1px solid #ddd";
          commentDiv.style.padding = "10px 0";

          const commentId = doc.id;

          const commentLikeBtn = document.createElement("button");
          commentLikeBtn.className = "action-btn"; // Use general action-btn class
          commentLikeBtn.textContent = `❤️ Like Comment (0)`;
          commentLikeBtn.style.marginTop = "5px";

          // Comment like button click handler
          commentLikeBtn.onclick = async () => {
            if (!currentUser) {
              showMessageBox("You need to be logged in to like comments.");
              return;
            }
            try {
              // Check if user already liked this specific comment
              const userCommentLikeDoc = await db
                .collection("commentLikes")
                .doc(commentId)
                .collection("users")
                .doc(currentUser.uid)
                .get();

              if (userCommentLikeDoc.exists) {
                showMessageBox("You already liked this comment!");
                return;
              }

              // Record user's like for this comment
              await db
                .collection("commentLikes")
                .doc(commentId)
                .collection("users")
                .doc(currentUser.uid)
                .set({ liked: true });

              // Update comment likes count using a transaction
              const commentLikesRef = db.collection("commentLikes").doc(commentId);
              await db.runTransaction(async (transaction) => {
                const docSnap = await transaction.get(commentLikesRef);
                if (!docSnap.exists) {
                  transaction.set(commentLikesRef, { count: 1 });
                } else {
                  const newCount = (docSnap.data().count || 0) + 1;
                  transaction.update(commentLikesRef, { count: newCount });
                }
              });

              // Update the displayed like count for this button
              const newCountDoc = await db.collection("commentLikes").doc(commentId).get();
              commentLikeBtn.textContent = `❤️ Like Comment (${newCountDoc.data().count || 0})`;
            } catch (err) {
              console.error("Error liking comment:", err);
              showMessageBox("Failed to like the comment.");
            }
          };

          // Immediately load likes for each comment when displayed
          (async () => {
            try {
              const commentLikesDoc = await db.collection("commentLikes").doc(commentId).get();
              const likesCount = commentLikesDoc.exists && commentLikesDoc.data().count ? commentLikesDoc.data().count : 0;
              commentLikeBtn.textContent = `❤️ Like Comment (${likesCount})`;
            } catch {
              commentLikeBtn.textContent = `❤️ Like Comment (0)`; // Fallback if error
            }
          })();

          // Construct comment HTML and append button
          commentDiv.innerHTML = `
            <strong>${escapeHtml(data.name)}</strong><br />
            <p>${escapeHtml(data.comment)}</p>
            <small>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : ""}</small>
            <br />
          `;
          commentDiv.appendChild(commentLikeBtn);
          commentsList.appendChild(commentDiv);
        });
      } catch (error) {
        console.error("Error loading comments:", error);
        commentsList.textContent = "Failed to load comments.";
      }
    }

    // Comment form submission handler
    commentForm.onsubmit = async (e) => {
      e.preventDefault(); // Prevent default form submission

      const name = document.getElementById("name").value.trim();
      const comment = document.getElementById("comment").value.trim();

      if (!name || !comment) {
        showMessageBox("Please fill out both fields.");
        return;
      }

      try {
        // Add new comment to Firestore
        await db.collection("comments").add({
          name,
          comment,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Use server timestamp
        });
        commentForm.reset(); // Clear form
        loadComments(); // Reload comments to show the new one
      } catch (error) {
        console.error("Error posting comment:", error);
        showMessageBox("Failed to post comment.");
      }
    };

    // Star rating click handler
    starsContainer.addEventListener("click", async (event) => {
      if (!currentUser) {
        showMessageBox("You need to be logged in to rate the article.");
        return;
      }

      const clickedStar = event.target.closest(".star");
      if (!clickedStar) return;

      const ratingValue = parseInt(clickedStar.dataset.value, 10);
      const userRatingRef = db.collection("ratings").doc(currentUser.uid); // Document for user's rating

      try {
        await userRatingRef.set({ rating: ratingValue }); // Set or update user's rating
        showStarRating(ratingValue); // Update star visuals
        ratingResult.textContent = `You rated this article ${ratingValue} star${ratingValue > 1 ? "s" : ""}.`;
      } catch (error) {
        console.error("Error submitting rating:", error);
        showMessageBox("Failed to submit rating.");
      }
    });

    // Function to load user's existing rating
    async function loadUserRating() {
      if (!currentUser) {
        showStarRating(0); // No user, no rating displayed
        ratingResult.textContent = "";
        return;
      }
      try {
        const userRatingDoc = await db.collection("ratings").doc(currentUser.uid).get();
        if (userRatingDoc.exists) {
          const ratingValue = userRatingDoc.data().rating;
          showStarRating(ratingValue);
          ratingResult.textContent = `You rated this article ${ratingValue} star${ratingValue > 1 ? "s" : ""}.`;
        } else {
          showStarRating(0); // User logged in but no rating yet
          ratingResult.textContent = "";
        }
      } catch (error) {
        console.error("Error loading rating:", error);
      }
    }

    // Function to visually update star rating
    function showStarRating(value) {
      const stars = document.querySelectorAll(".star");
      stars.forEach((star) => {
        const starValue = parseInt(star.dataset.value, 10);
        star.style.color = starValue <= value ? "gold" : "lightgray";
      });
    }

    // Custom message box function to replace alert()
    function showMessageBox(message) {
      const messageBox = document.createElement('div');
      messageBox.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        font-family: 'Montserrat', sans-serif;
        font-size: 1.1rem;
        color: #333;
        max-width: 80%;
        min-width: 250px;
      `;
      messageBox.innerHTML = `
        <p>${message}</p>
        <button style="
          background-color: #2ECC71;
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
          margin-top: 15px;
          font-weight: bold;
        ">OK</button>
      `;
      document.body.appendChild(messageBox);

      messageBox.querySelector('button').onclick = () => {
        document.body.removeChild(messageBox);
      };
    }
  </script>
</body>
</html>