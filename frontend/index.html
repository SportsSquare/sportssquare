<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sports Square</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- AdSense and Analytics Scripts -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7385129367264824" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6CR81XMZN5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-6CR81XMZN5');
  </script>

  <style>
    body {
      background-color: rgb(249, 251, 231);
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      padding: 20px; /* Reduced padding for smaller screens */
      margin: 0;
    }
    nav ul {
      list-style-type: none;
      padding: 0;
      display: flex;
      justify-content: center;
      gap: 15px; /* Adjusted gap */
      flex-wrap: wrap; /* Allow nav items to wrap */
    }
    .flex-section {
      display: flex;
      justify-content: center; /* Center items for better wrapping */
      align-items: flex-start;
      gap: 40px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .post-card {
      border: 1px solid black;
      padding: 20px;
      width: 100%; /* Full width on small screens */
      max-width: 320px; /* Max-width for larger screens */
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    aside.poll-box {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      font-family: 'Segoe UI', sans-serif;
      width: 100%; /* Full width on small screens */
      max-width: 320px; /* Max-width for larger screens */
    }
    #hero {
        width: 90%;
        max-width: 600px;
    }
    button, input[type="submit"] {
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    button:hover, input[type="submit"]:hover {
        opacity: 0.9;
    }
  </style>
</head>

<body>
    <!-- Header -->
    <div style="text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <h1 style="color:blue; margin: 0; width: 100%; text-align: center;">Sports Square</h1>
        <button onclick="location.href='./signup.html'" style="padding: 10px 20px; background-color: #2ECC71; color: white; font-size: 16px; font-weight: bold; border: none; border-radius: 6px;">Signup</button>
        <button onclick="location.href='./login.html'" style="padding: 10px 20px; background-color: #3498DB; color: white; font-size: 16px; font-weight: bold; border: none; border-radius: 6px;">Login</button>
    </div>

    <!-- Search Bar -->
    <input type="text" id="search" placeholder="Search for posts..." style="width: 80%; max-width: 300px; padding: 10px; margin-bottom: 20px; border-radius: 6px; border: 1px solid #ccc;">

    <!-- Main Navigation -->
    <nav style="margin: 20px 0; background-color: rgb(255, 208, 0); padding: 10px; border-radius: 8px;">
        <ul>
            <li><a href="./index.html">Home</a></li>
            <li><a href="">Posts</a></li>
            <li><a href="./sportscalendar.html">Calendar</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="collaborations.html">Collaborations</a></li>
            <li><a href="./careers.html">Careers</a></li>
        </ul>
    </nav>

    <!-- Hero Section -->
    <div id="hero" style="border: 3px solid black; padding: 20px; margin: 20px auto; background-color: white; border-radius: 10px;">
        <h2>Where Sports Meet Their Match</h2>
        <h3>Fresh takes, game-day insights, and behind-the-scenes sports stories ‚Äî straight to your inbox.</h3>
        <h2><em>Join the Square</em></h2>
        <form action="https://formsubmit.co/sportssquareauthor@gmail.com" method="POST">
            <input type="email" name="email" placeholder="Your email" required style="width: 80%; max-width: 300px; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc;">
            <input type="hidden" name="_next" value="https://sportssquare.netlify.app/subscribed">
            <input type="hidden" name="_captcha" value="false">
            <input type="hidden" name="_subject" value="New subscription from Sports Square">
            <input type="hidden"name="_message" value="A new user has subscribed to Sports Square.">
            <br>
            <button type="submit" style="width:200px; height: 50px; background-color: #2ECC71; color: white; padding: 10px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px;">Subscribe</button>
        </form>
    </div>

    <hr style="border: 1px solid black; margin: 40px 0;">

    <!-- Featured Post -->
    <figure>
        <h1>FEATURED:</h1>
        <a href="./posts/so-long-pops.html" style="color:blue"><h2>So Long Pops</h2></a>
        <a href="./posts/so-long-pops.html" style="color:black; text-decoration: none;">
            <h4>From Air Force Cadet to NBA Legend: The Unmatched Legacy of Coach Popovich</h4>
            <img src="https://placehold.co/600x400/cccccc/000000?text=Coach+Popovich" alt="Gregg Popovich" style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px;">
            <figcaption>For nearly three decades, Gregg Popovich wasn't just coaching basketball ‚Äî he was redefining it. From humble beginnings at a tiny DIII college to five NBA titles and Olympic gold, Pop's journey is a masterclass in leadership, grit, and principle.</figcaption>
        </a>
        <p>By: <a href="./posts/smayan.html">Smayan Srikanth</a></p>
    </figure>

    <hr style="border: 1px solid black; margin: 40px 0;">

    <!-- Sports Navigation -->
    <nav style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap;">
        <button onclick="location.href='./nfl.html'" style="width: 150px; height: 50px; border-radius: 6px; border: 1px solid black;">NFL</button>
        <button onclick="location.href='./mlb.html'" style="width: 150px; height: 50px; border-radius: 6px; border: 1px solid black;">MLB</button>
        <button onclick="location.href='./nba.html'" style="width: 150px; height: 50px; border-radius: 6px; border: 1px solid black;">NBA</button>
    </nav>

    <hr style="border: 1px solid black; margin: 40px 0;">

    <h2>Latest Posts</h2>
    <div class="flex-section">
        <!-- Post Card -->
        <div class="post-card">
            <h3><a href="./posts/so-long-pops.html" style="color:blue">So Long Pops</a></h3>
            <p>From Air Force Cadet to NBA Legend: The Unmatched Legacy of Coach Popovich</p>
            <p>By: <a href="./posts/smayan.html">Smayan Srikanth</a></p>
        </div>

        <!-- Poll Section -->
        <aside class="poll-box">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">üèÄ Fan Poll</h3>
            <p style="margin-bottom: 1rem;">Who will win the NBA Finals?</p>
            <form id="pollForm" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label><input type="radio" name="vote" value="O1"> Thunder</label>
                <label><input type="radio" name="vote" value="O3"> Pacers</label>
                <button type="submit" style="margin-top: 1rem; padding: 0.5rem; background-color: #2ecc71; color: white; border: none; border-radius: 4px;">Vote</button>
            </form>
            <div id="pollResult" style="margin-top: 1rem; font-size: 0.95rem; color: #2d3436;"></div>
            <div id="pollCounts" style="margin-top: 1rem; font-size: 0.95rem; color: #34495e;"></div>
        </aside>
    </div>

    <hr style="border: 1px solid black; margin: 40px 0;">

    <!-- Footer -->
    <footer style="margin-top: 40px; padding: 20px; background-color: rgb(255, 208, 0);">
        <p>¬© 2025 Sports Square. All rights reserved.</p>
        <p>Follow us on <a href="https://twitter.com/sportssquare" target="_blank">Twitter</a></p>
    </footer>

    <!-- Main Application Script using Modules -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization & Auth ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let app, auth, db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");

            // One-time sign-in attempt
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 signInWithCustomToken(auth, __initial_auth_token)
                    .then(() => console.log("Signed in with custom token."))
                    .catch(err => console.error("Custom token sign-in failed:", err));
            } else {
                 signInAnonymously(auth)
                    .then(() => console.log("Signed in anonymously."))
                    .catch(err => console.error("Anonymous sign-in failed:", err));
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        // --- Search Bar Logic ---
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    const searchTerm = this.value.toLowerCase().trim();
                    if (["so longpops", "so long pops", "solongpops", "solong pops"].includes(searchTerm)) {
                        window.location.href = './posts/so-long-pops.html';
                    } else if (["smayan", "smayan srikanth"].includes(searchTerm)) {
                        window.location.href = './posts/smayan.html';
                    } else if (["sports calendar", "calendar"].includes(searchTerm)) {
                        window.location.href = './sportscalendar.html';
                    } else if (["dashboard"].includes(searchTerm)) {
                        window.location.href = './dashboard.html';
                    } else if (["subscribed"].includes(searchTerm)) {
                        window.location.href = './subscribed.html';
                    }
                }
            });
        }

        // --- Poll Logic ---
        const pollForm = document.getElementById('pollForm');
        if (pollForm) {
            const resultDiv = document.getElementById('pollResult');
            const countsDiv = document.getElementById('pollCounts');
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWyaj5EOkvdBZ_CUAI8AT9k41u2ovK3F-q0XlCvCwyLv4REagM0dydH57WJP5iCINj/exec';

            pollForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const selected = document.querySelector('input[name="vote"]:checked');
                if (!selected) {
                    resultDiv.textContent = '‚ö†Ô∏è Please select an option before submitting.';
                    return;
                }

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Use no-cors for this type of endpoint if it doesn't support CORS
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `vote=${encodeURIComponent(selected.value)}`
                })
                .then(() => {
                    // Because of no-cors, we can't read the response, but the request is sent.
                    resultDiv.textContent = '‚úÖ Thanks for voting! Your vote has been recorded.';
                    pollForm.style.display = 'none';
                    fetchResults(); // Refresh results immediately
                })
                .catch(() => {
                    resultDiv.textContent = '‚ö†Ô∏è Sorry, could not submit your vote.';
                });
            });

            function fetchResults() {
                fetch(GOOGLE_SCRIPT_URL)
                    .then(response => response.json())
                    .then(counts => {
                        countsDiv.innerHTML = `
                            üó≥Ô∏è Current Results:<br>
                            ‚Ä¢ Thunder: ${counts.O1 || 0}<br>
                            ‚Ä¢ Pacers: ${counts.O3 || 0}
                        `;
                    })
                    .catch(() => {
                        countsDiv.textContent = '‚ö†Ô∏è Unable to load current results.';
                    });
            }

            fetchResults();
            setInterval(fetchResults, 30000); // Refresh every 30 seconds
        }

        // --- Notifications Logic (Now correctly placed and using modules) ---
        if (db) { // Only run if Firebase initialized correctly
            // Create notification UI elements dynamically
            const btn = document.createElement('div');
            btn.id = 'notification-btn';
            btn.title = 'Notifications';
            Object.assign(btn.style, {
                position: 'fixed', top: '10px', right: '10px', fontSize: '28px',
                cursor: 'pointer', userSelect: 'none', zIndex: '9999'
            });
            btn.innerHTML = 'üîî<span id="notification-badge" style="position:absolute; top:0; right:0; background:red; color:white; border-radius:50%; padding:2px 7px; font-size:14px; display:none;"></span>';
            document.body.appendChild(btn);

            const container = document.createElement('div');
            container.id = 'notifications';
            Object.assign(container.style, {
                maxWidth: '320px', maxHeight: '300px', overflowY: 'auto', border: '1px solid #ccc',
                padding: '10px', marginTop: '10px', background: '#fff', display: 'none',
                fontFamily: 'Arial, sans-serif', position: 'fixed', top: '50px', right: '10px', zIndex: '9999'
            });
            document.body.appendChild(container);
            
            const notificationBtn = document.getElementById('notification-btn');
            const badge = document.getElementById('notification-badge');
            const notificationsContainer = document.getElementById('notifications');

            let currentUser = null;
            let notifications = [];

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    startListeningNotifications();
                } else {
                    currentUser = null;
                    badge.style.display = 'none';
                    notificationsContainer.style.display = 'none';
                    notificationsContainer.innerHTML = '';
                }
            });

            function startListeningNotifications() {
                const notificationsPath = `artifacts/${appId}/public/data/notifications`;
                const notificationsQuery = query(collection(db, notificationsPath), orderBy('timestamp', 'desc'));
                onSnapshot(notificationsQuery, snapshot => {
                    notifications = [];
                    snapshot.forEach(doc => {
                        notifications.push({ id: doc.id, ...doc.data() });
                    });
                    updateNotificationUI();
                }, error => {
                    console.error("Error listening to notifications:", error);
                });
            }

            function isRead(notification) {
                if (!currentUser || !notification.readBy) return false;
                return notification.readBy.includes(currentUser.uid);
            }

            function updateNotificationUI() {
                const unreadCount = notifications.filter(n => !isRead(n)).length;
                badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
                badge.textContent = unreadCount;

                if (notifications.length === 0) {
                    notificationsContainer.innerHTML = '<p style="text-align: center; margin: 10px;">No notifications</p>';
                    return;
                }

                notificationsContainer.innerHTML = notifications.map(n => {
                    const time = n.timestamp?.toDate ? n.timestamp.toDate().toLocaleString() : 'Just now';
                    const readClass = isRead(n) ? '' : 'unread';
                    const readStyle = isRead(n) ? '' : 'font-weight:bold; background-color:#f0f8ff;';
                    return `
                        <div class="notification-item ${readClass}" data-id="${n.id}" style="padding:8px; border-bottom:1px solid #eee; cursor:pointer; ${readStyle}">
                            ${n.message}<br>
                            <small>${time}</small>
                        </div>
                    `;
                }).join('');
            }

            notificationsContainer.addEventListener('click', e => {
                const item = e.target.closest('.notification-item');
                if (item) markAsRead(item.getAttribute('data-id'));
            });

            async function markAsRead(notificationId) {
                if (!currentUser) return;
                const notificationsPath = `artifacts/${appId}/public/data/notifications`;
                const notifRef = doc(db, notificationsPath, notificationId);
                try {
                    await updateDoc(notifRef, { readBy: arrayUnion(currentUser.uid) });
                } catch (error) {
                    console.error("Error marking notification as read:", error);
                }
            }
            
            notificationBtn.addEventListener('click', () => {
                const isVisible = notificationsContainer.style.display === 'block';
                notificationsContainer.style.display = isVisible ? 'none' : 'block';
                if (!isVisible && currentUser) {
                    notifications.forEach(n => { if (!isRead(n)) markAsRead(n.id); });
                }
            });
        }
    </script>
</body>
</html>